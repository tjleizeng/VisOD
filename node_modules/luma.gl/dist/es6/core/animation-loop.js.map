{"version":3,"sources":["../../../src/core/animation-loop.js"],"names":["createGLContext","resizeGLContext","resetParameters","getPageLoadPromise","makeDebugContext","isWebGL","requestAnimationFrame","cancelAnimationFrame","log","assert","Framebuffer","DEFAULT_GL_OPTIONS","preserveDrawingBuffer","AnimationLoop","constructor","props","onCreateContext","opts","onAddHTML","onInitialize","onRender","onFinalize","gl","glOptions","debug","createFramebuffer","autoResizeViewport","autoResizeDrawingBuffer","useDevicePixels","deprecated","useDevicePixelRatio","needsRedraw","_initialized","_running","_animationFrameId","_startPromise","setProps","start","bind","stop","_onMousemove","_onMouseleave","setNeedsRedraw","reason","then","_createWebGLContext","_createFramebuffer","_startEventHandling","_initializeCallbackData","_updateCallbackData","_resizeCanvasDrawingBuffer","_resizeViewport","initializationPromise","animationProps","appContext","_addCallbackData","_startLoop","redraw","_setupFrame","_clearNeedsRedraw","offScreen","commit","_finalizeCallbackData","args","getHTMLControlValue","id","defaultValue","element","document","getElementById","Number","value","setViewParameters","removed","renderFrame","_onSetupFrame","_resizeFramebuffer","canvas","framebuffer","startTime","Date","now","time","tick","tock","_loop","_animationLoop","_mousePosition","_getSizeAndAspect","width","height","aspect","Math","floor","_offScreen","Object","assign","OffscreenCanvas","Error","_createInfoDiv","wrapperDiv","createElement","body","appendChild","style","position","div","left","bottom","background","html","innerHTML","drawingBufferWidth","drawingBufferHeight","clientWidth","clientHeight","viewport","resize","addEventListener","e","offsetX","offsetY"],"mappings":"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","sourcesContent":["/* global OffscreenCanvas */\nimport {createGLContext, resizeGLContext, resetParameters} from '../webgl-context';\nimport {getPageLoadPromise} from '../webgl-context';\nimport {makeDebugContext} from '../webgl-context/debug-context';\nimport {isWebGL, requestAnimationFrame, cancelAnimationFrame} from '../webgl-utils';\nimport {log} from '../utils';\nimport assert from '../utils/assert';\n\n// TODO - remove dependency on webgl classes\nimport {Framebuffer} from '../webgl';\n\nconst DEFAULT_GL_OPTIONS = {\n  preserveDrawingBuffer: true\n};\n\nexport default class AnimationLoop {\n  /*\n   * @param {HTMLCanvasElement} canvas - if provided, width and height will be passed to context\n   */\n  constructor(props = {}) {\n    const {\n      onCreateContext = opts => createGLContext(opts),\n      onAddHTML = null,\n      onInitialize = () => {},\n      onRender = () => {},\n      onFinalize = () => {},\n\n      gl = null,\n      glOptions = {},\n      debug = false,\n\n      createFramebuffer = false,\n\n      // view parameters\n      autoResizeViewport = true,\n      autoResizeDrawingBuffer = true\n    } = props;\n\n    let {useDevicePixels = true} = props;\n\n    if ('useDevicePixelRatio' in props) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n      useDevicePixels = props.useDevicePixelRatio;\n    }\n\n    this.props = {\n      onCreateContext,\n      onAddHTML,\n      onInitialize,\n      onRender,\n      onFinalize,\n\n      gl,\n      glOptions,\n      debug,\n      createFramebuffer\n    };\n\n    // state\n    this.gl = gl;\n    this.needsRedraw = null;\n\n    this._initialized = false;\n    this._running = false;\n    this._animationFrameId = null;\n    this._startPromise = null;\n\n    this.setProps({\n      autoResizeViewport,\n      autoResizeDrawingBuffer,\n      useDevicePixels\n    });\n\n    // Bind methods\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n\n    this._onMousemove = this._onMousemove.bind(this);\n    this._onMouseleave = this._onMouseleave.bind(this);\n\n    return this;\n  }\n\n  setNeedsRedraw(reason) {\n    assert(typeof reason === 'string');\n    this.needsRedraw = this.needsRedraw || reason;\n    return this;\n  }\n\n  setProps(props) {\n    if ('autoResizeViewport' in props) {\n      this.autoResizeViewport = props.autoResizeViewport;\n    }\n    if ('autoResizeDrawingBuffer' in props) {\n      this.autoResizeDrawingBuffer = props.autoResizeDrawingBuffer;\n    }\n    if ('useDevicePixels' in props) {\n      this.useDevicePixels = props.useDevicePixels;\n    }\n    return this;\n  }\n\n  // Starts a render loop if not already running\n  // @param {Object} context - contains frame specific info (E.g. tick, width, height, etc)\n  start(opts = {}) {\n    if (this._running) {\n      return this;\n    }\n    this._running = true;\n    // console.debug(`Starting ${this.constructor.name}`);\n    // Wait for start promise before rendering frame\n    this._startPromise = getPageLoadPromise()\n      .then(() => {\n        if (!this._running || this._initialized) {\n          return null;\n        }\n\n        // Create the WebGL context\n        this._createWebGLContext(opts);\n        this._createFramebuffer();\n        this._startEventHandling();\n\n        // Initialize the callback data\n        this._initializeCallbackData();\n        this._updateCallbackData();\n\n        // Default viewport setup, in case onInitialize wants to render\n        this._resizeCanvasDrawingBuffer();\n        this._resizeViewport();\n\n        // Note: onIntialize can return a promise (in case it needs to load resources)\n        const initializationPromise = this.onInitialize(this.animationProps);\n        this._initialized = true;\n        return initializationPromise;\n      })\n      .then(appContext => {\n        if (this._running) {\n          this._addCallbackData(appContext || {});\n          if (appContext !== false) {\n            this._startLoop();\n          }\n        }\n      });\n    return this;\n  }\n\n  // Redraw now\n  redraw() {\n    this._setupFrame();\n    this._updateCallbackData();\n\n    // call callback\n    this.onRender(this.animationProps);\n    // end callback\n\n    // clear needsRedraw flag\n    this._clearNeedsRedraw();\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/commit\n    // Chrome's offscreen canvas does not require gl.commit\n    if (this.offScreen && this.gl.commit) {\n      this.gl.commit();\n    }\n    return this;\n  }\n\n  // Stops a render loop if already running, finalizing\n  stop() {\n    // console.debug(`Stopping ${this.constructor.name}`);\n    if (this._running) {\n      this._finalizeCallbackData();\n      cancelAnimationFrame(this._animationFrameId);\n      this._animationFrameId = null;\n      this._running = false;\n    }\n    return this;\n  }\n\n  onCreateContext(...args) {\n    return this.props.onCreateContext(...args);\n  }\n\n  onInitialize(...args) {\n    return this.props.onInitialize(...args);\n  }\n\n  onRender(...args) {\n    return this.props.onRender(...args);\n  }\n\n  onFinalize(...args) {\n    return this.props.onFinalize(...args);\n  }\n\n  // DEPRECATED/REMOVED METHODS\n\n  getHTMLControlValue(id, defaultValue = 1) {\n    const element = document.getElementById(id);\n    return element ? Number(element.value) : defaultValue;\n  }\n\n  // Update parameters\n  setViewParameters() {\n    log.removed('AnimationLoop.setViewParameters', 'AnimationLoop.setProps')();\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _startLoop() {\n    const renderFrame = () => {\n      if (!this._running) {\n        return;\n      }\n      this.redraw();\n      this._animationFrameId = requestAnimationFrame(renderFrame);\n    };\n\n    // cancel any pending renders to ensure only one loop can ever run\n    cancelAnimationFrame(this._animationFrameId);\n    this._animationFrameId = requestAnimationFrame(renderFrame);\n  }\n\n  _clearNeedsRedraw() {\n    this.needsRedraw = null;\n  }\n\n  _setupFrame() {\n    if (this._onSetupFrame) {\n      // call callback\n      this._onSetupFrame(this.animationProps);\n      // end callback\n    } else {\n      this._resizeCanvasDrawingBuffer();\n      this._resizeViewport();\n      this._resizeFramebuffer();\n    }\n  }\n\n  // Initialize the  object that will be passed to app callbacks\n  _initializeCallbackData() {\n    this.animationProps = {\n      gl: this.gl,\n\n      stop: this.stop,\n      canvas: this.gl.canvas,\n      framebuffer: this.framebuffer,\n\n      // Initial values\n      useDevicePixels: this.useDevicePixels,\n      needsRedraw: null,\n\n      // Animation props\n      startTime: Date.now(),\n      time: 0,\n      tick: 0,\n      tock: 0,\n      // canvas\n\n      // Experimental\n      _loop: this,\n      _animationLoop: this,\n      _mousePosition: null // Event props\n    };\n  }\n\n  // Update the context object that will be passed to app callbacks\n  _updateCallbackData() {\n    const {width, height, aspect} = this._getSizeAndAspect();\n    if (width !== this.animationProps.width || height !== this.animationProps.height) {\n      this.setNeedsRedraw('drawing buffer resized');\n    }\n    if (aspect !== this.animationProps.aspect) {\n      this.setNeedsRedraw('drawing buffer aspect changed');\n    }\n\n    this.animationProps.width = width;\n    this.animationProps.height = height;\n    this.animationProps.aspect = aspect;\n\n    this.animationProps.needsRedraw = this.needsRedraw;\n\n    // Increment tick\n    this.animationProps.time = Date.now() - this.animationProps.startTime;\n    this.animationProps.tick = Math.floor((this.animationProps.time / 1000) * 60);\n    this.animationProps.tock++;\n\n    // experimental\n    this.animationProps._offScreen = this.offScreen;\n  }\n\n  _finalizeCallbackData() {\n    // call callback\n    this.onFinalize(this.animationProps);\n    // end callback\n  }\n\n  // Add application's data to the app context object\n  _addCallbackData(appContext) {\n    if (typeof appContext === 'object' && appContext !== null) {\n      this.animationProps = Object.assign({}, this.animationProps, appContext);\n    }\n  }\n\n  // Either uses supplied or existing context, or calls provided callback to create one\n  _createWebGLContext(opts) {\n    this.offScreen =\n      opts.canvas &&\n      typeof OffscreenCanvas !== 'undefined' &&\n      opts.canvas instanceof OffscreenCanvas;\n\n    // Create the WebGL context if necessary\n    opts = Object.assign({}, opts, DEFAULT_GL_OPTIONS, this.props.glOptions);\n    this.gl = this.props.gl || this.onCreateContext(opts);\n\n    if (!isWebGL(this.gl)) {\n      throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n    }\n\n    if (this.props.debug) {\n      this.gl = makeDebugContext(this.gl);\n    }\n\n    // Reset the WebGL context.\n    resetParameters(this.gl);\n\n    this._createInfoDiv();\n  }\n\n  _createInfoDiv() {\n    if (this.gl.canvas && this.props.onAddHTML) {\n      /* global document */\n      const wrapperDiv = document.createElement('div');\n      document.body.appendChild(wrapperDiv);\n      wrapperDiv.style.position = 'relative';\n      const div = document.createElement('div');\n      div.style.position = 'absolute';\n      div.style.left = '10px';\n      div.style.bottom = '10px';\n      div.style.width = '300px';\n      div.style.background = 'white';\n      wrapperDiv.appendChild(this.gl.canvas);\n      wrapperDiv.appendChild(div);\n      const html = this.props.onAddHTML(div);\n      if (html) {\n        div.innerHTML = html;\n      }\n    }\n  }\n\n  _getSizeAndAspect() {\n    // https://webglfundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html\n    const width = this.gl.drawingBufferWidth;\n    const height = this.gl.drawingBufferHeight;\n\n    // https://webglfundamentals.org/webgl/lessons/webgl-anti-patterns.html\n    let aspect = 1;\n    const {clientWidth, clientHeight} = this.gl.canvas;\n    if (clientWidth >= 0 && clientHeight >= 0) {\n      aspect = height > 0 ? clientWidth / clientHeight : 1;\n    } else if (width > 0 && height > 0) {\n      aspect = width / height;\n    }\n\n    return {width, height, aspect};\n  }\n\n  // Default viewport setup\n  _resizeViewport() {\n    if (this.autoResizeViewport) {\n      this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n    }\n  }\n\n  // Resize the render buffer of the canvas to match canvas client size\n  // Optionally multiplying with devicePixel ratio\n  _resizeCanvasDrawingBuffer() {\n    if (this.autoResizeDrawingBuffer) {\n      resizeGLContext(this.gl, {useDevicePixels: this.useDevicePixels});\n    }\n  }\n\n  // TBD - deprecated?\n  _createFramebuffer() {\n    // Setup default framebuffer\n    if (this.props.createFramebuffer) {\n      this.framebuffer = new Framebuffer(this.gl);\n    }\n  }\n\n  _resizeFramebuffer() {\n    if (this.framebuffer) {\n      this.framebuffer.resize({\n        width: this.gl.drawingBufferWidth,\n        height: this.gl.drawingBufferHeight\n      });\n    }\n  }\n\n  // Event handling\n\n  _startEventHandling() {\n    this.gl.canvas.addEventListener('mousemove', this._onMousemove);\n    this.gl.canvas.addEventListener('mouseleave', this._onMouseleave);\n  }\n\n  _onMousemove(e) {\n    this.animationProps._mousePosition = [e.offsetX, e.offsetY];\n  }\n  _onMouseleave(e) {\n    this.animationProps._mousePosition = null;\n  }\n}\n"],"file":"animation-loop.js"}