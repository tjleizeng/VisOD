{"version":3,"sources":["../../../src/lib/pick-layers.js"],"names":["NO_PICKED_OBJECT","pickedColor","pickedLayer","pickedObjectIndex","pickObject","gl","layers","viewports","x","y","radius","layerFilter","depth","mode","onViewportActive","pickingFBO","lastPickedInfo","useDevicePixels","pixelRatio","deviceX","Math","round","deviceY","canvas","height","deviceRadius","deviceRect","getPickingRect","deviceWidth","width","deviceHeight","result","affectedLayers","i","pickedColors","drawAndSamplePickingBuffer","redrawReason","pickInfo","getClosestFromPickingBuffer","layerId","copyPickingColors","clearPickingColor","processedPickInfos","processPickInfo","forEach","info","push","Object","keys","restorePickingColors","pickVisibleObjects","deviceLeft","deviceBottom","deviceRight","deviceTop","pickInfos","getUniquesFromPickingBuffer","uniqueInfos","Map","color","layer","index","picked","getLayerPickingInfo","has","object","set","Array","from","values","Number","isFinite","pickableLayers","filter","isPickable","length","Uint8Array","readPixels","pixelArray","getViewportFromCoordinates","viewport","valid","max","min","lastPickedObjectIndex","lastPickedLayerId","pickedLayerId","props","id","lastPickedLayer","find","unshift","coordinate","unproject","baseInfo","pixel","lngLat","devicePixel","infos","assign","pickingSelectedColor","autoHighlight","setModuleParameters","setNeedsRedraw","unhandledPickInfos","callLayerPickingCallbacks","handled","onClick","onHover","Error","minSquareDistanceToCenter","closestPixelIndex","row","dy","dy2","col","pickedLayerIndex","dx","d2","slice","decodePickingColor","log","error","uniqueColors","colorKey","join","sourceLayer","pickLayer","parent"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {drawPickingBuffer, getPixelRatio} from './draw-layers';\nimport log from '../utils/log';\nimport assert from '../utils/assert';\n\nconst NO_PICKED_OBJECT = {\n  pickedColor: null,\n  pickedLayer: null,\n  pickedObjectIndex: -1\n};\n\n/* eslint-disable max-depth, max-statements */\n// Pick the closest object at the given (x,y) coordinate\nexport function pickObject(\n  gl,\n  {\n    layers,\n    viewports,\n    x,\n    y,\n    radius,\n    layerFilter,\n    depth = 1,\n    mode,\n    onViewportActive,\n    pickingFBO,\n    lastPickedInfo,\n    useDevicePixels\n  }\n) {\n  // Convert from canvas top-left to WebGL bottom-left coordinates\n  // And compensate for pixelRatio\n  const pixelRatio = getPixelRatio({useDevicePixels});\n  const deviceX = Math.round(x * pixelRatio);\n  const deviceY = Math.round(gl.canvas.height - y * pixelRatio);\n  const deviceRadius = Math.round(radius * pixelRatio);\n\n  const deviceRect = getPickingRect({\n    deviceX,\n    deviceY,\n    deviceRadius,\n    deviceWidth: pickingFBO.width,\n    deviceHeight: pickingFBO.height\n  });\n\n  const result = [];\n  const affectedLayers = {};\n\n  for (let i = 0; i < depth; i++) {\n    const pickedColors =\n      deviceRect &&\n      drawAndSamplePickingBuffer(gl, {\n        layers,\n        viewports,\n        onViewportActive,\n        useDevicePixels,\n        pickingFBO,\n        deviceRect,\n        layerFilter,\n        redrawReason: mode\n      });\n\n    const pickInfo =\n      (pickedColors &&\n        getClosestFromPickingBuffer(gl, {\n          pickedColors,\n          layers,\n          deviceX,\n          deviceY,\n          deviceRadius,\n          deviceRect\n        })) ||\n      NO_PICKED_OBJECT;\n\n    // Only exclude if we need to run picking again.\n    // We need to run picking again if an object is detected AND\n    // we have not exhausted the requested depth.\n    if (pickInfo.pickedColor && i + 1 < depth) {\n      const layerId = pickInfo.pickedColor[3] - 1;\n      if (!affectedLayers[layerId]) {\n        // backup original colors\n        affectedLayers[layerId] = layers[layerId].copyPickingColors();\n      }\n      layers[layerId].clearPickingColor(pickInfo.pickedColor);\n    }\n\n    // This logic needs to run even if no object is picked.\n    const processedPickInfos = processPickInfo({\n      pickInfo,\n      lastPickedInfo,\n      mode,\n      layers,\n      viewports,\n      x,\n      y,\n      deviceX,\n      deviceY,\n      pixelRatio\n    });\n\n    if (processedPickInfos) {\n      processedPickInfos.forEach(info => result.push(info));\n    }\n\n    // If no object is picked stop.\n    if (!pickInfo.pickedColor) {\n      break;\n    }\n  }\n\n  // reset only affected buffers\n  Object.keys(affectedLayers).forEach(layerId =>\n    layers[layerId].restorePickingColors(affectedLayers[layerId])\n  );\n\n  return result;\n}\n\n// Pick all objects within the given bounding box\nexport function pickVisibleObjects(\n  gl,\n  {\n    layers,\n    viewports,\n    x,\n    y,\n    width,\n    height,\n    mode,\n    layerFilter,\n    onViewportActive,\n    pickingFBO,\n    useDevicePixels\n  }\n) {\n  // Convert from canvas top-left to WebGL bottom-left coordinates\n  // And compensate for pixelRatio\n  const pixelRatio = getPixelRatio({useDevicePixels});\n\n  const deviceLeft = Math.round(x * pixelRatio);\n  const deviceBottom = Math.round(gl.canvas.height - y * pixelRatio);\n  const deviceRight = Math.round((x + width) * pixelRatio);\n  const deviceTop = Math.round(gl.canvas.height - (y + height) * pixelRatio);\n\n  const deviceRect = {\n    x: deviceLeft,\n    y: deviceTop,\n    width: deviceRight - deviceLeft,\n    height: deviceBottom - deviceTop\n  };\n\n  const pickedColors = drawAndSamplePickingBuffer(gl, {\n    layers,\n    viewports,\n    onViewportActive,\n    pickingFBO,\n    useDevicePixels,\n    deviceRect,\n    layerFilter,\n    redrawReason: mode\n  });\n\n  const pickInfos = getUniquesFromPickingBuffer(gl, {pickedColors, layers});\n\n  // Only return unique infos, identified by info.object\n  const uniqueInfos = new Map();\n\n  pickInfos.forEach(pickInfo => {\n    let info = {\n      color: pickInfo.pickedColor,\n      layer: null,\n      index: pickInfo.pickedObjectIndex,\n      picked: true,\n      x,\n      y,\n      width,\n      height,\n      pixelRatio\n    };\n\n    info = getLayerPickingInfo({layer: pickInfo.pickedLayer, info, mode});\n    if (!uniqueInfos.has(info.object)) {\n      uniqueInfos.set(info.object, info);\n    }\n  });\n\n  return Array.from(uniqueInfos.values());\n}\n\n// HELPER METHODS\n\n// returns pickedColor or null if no pickable layers found.\nfunction drawAndSamplePickingBuffer(\n  gl,\n  {\n    layers,\n    viewports,\n    onViewportActive,\n    useDevicePixels,\n    pickingFBO,\n    deviceRect,\n    layerFilter,\n    redrawReason\n  }\n) {\n  assert(deviceRect);\n  assert(Number.isFinite(deviceRect.width) && deviceRect.width > 0, '`width` must be > 0');\n  assert(Number.isFinite(deviceRect.height) && deviceRect.height > 0, '`height` must be > 0');\n\n  const pickableLayers = layers.filter(layer => layer.isPickable());\n  if (pickableLayers.length < 1) {\n    return null;\n  }\n\n  drawPickingBuffer(gl, {\n    layers,\n    viewports,\n    onViewportActive,\n    useDevicePixels,\n    pickingFBO,\n    deviceRect,\n    layerFilter,\n    redrawReason\n  });\n\n  // Read from an already rendered picking buffer\n  // Returns an Uint8ClampedArray of picked pixels\n  const {x, y, width, height} = deviceRect;\n  const pickedColors = new Uint8Array(width * height * 4);\n  pickingFBO.readPixels({x, y, width, height, pixelArray: pickedColors});\n  return pickedColors;\n}\n\n// Indentifies which viewport, if any corresponds to x and y\n// Returns first viewport if no match\n// TODO - need to determine which viewport we are in\n// TODO - document concept of \"primary viewport\" that matches all coords?\n// TODO - static method on Viewport class?\nfunction getViewportFromCoordinates({viewports}) {\n  const viewport = viewports[0];\n  return viewport;\n}\n\n// Calculate a picking rect centered on deviceX and deviceY and clipped to device\n// Returns null if pixel is outside of device\nfunction getPickingRect({deviceX, deviceY, deviceRadius, deviceWidth, deviceHeight}) {\n  const valid = deviceX >= 0 && deviceY >= 0 && deviceX < deviceWidth && deviceY < deviceHeight;\n\n  // x, y out of bounds.\n  if (!valid) {\n    return null;\n  }\n\n  // Create a box of size `radius * 2 + 1` centered at [deviceX, deviceY]\n  const x = Math.max(0, deviceX - deviceRadius);\n  const y = Math.max(0, deviceY - deviceRadius);\n  const width = Math.min(deviceWidth, deviceX + deviceRadius) - x + 1;\n  const height = Math.min(deviceHeight, deviceY + deviceRadius) - y + 1;\n\n  return {x, y, width, height};\n}\n\n// TODO - break this monster function into 3+ parts\nfunction processPickInfo({\n  pickInfo,\n  lastPickedInfo,\n  mode,\n  layers,\n  viewports,\n  x,\n  y,\n  deviceX,\n  deviceY,\n  pixelRatio\n}) {\n  const {pickedColor, pickedLayer, pickedObjectIndex} = pickInfo;\n\n  const affectedLayers = pickedLayer ? [pickedLayer] : [];\n\n  if (mode === 'hover') {\n    // only invoke onHover events if picked object has changed\n    const lastPickedObjectIndex = lastPickedInfo.index;\n    const lastPickedLayerId = lastPickedInfo.layerId;\n    const pickedLayerId = pickedLayer && pickedLayer.props.id;\n\n    // proceed only if picked object changed\n    if (pickedLayerId !== lastPickedLayerId || pickedObjectIndex !== lastPickedObjectIndex) {\n      if (pickedLayerId !== lastPickedLayerId) {\n        // We cannot store a ref to lastPickedLayer in the context because\n        // the state of an outdated layer is no longer valid\n        // and the props may have changed\n        const lastPickedLayer = layers.find(layer => layer.props.id === lastPickedLayerId);\n        if (lastPickedLayer) {\n          // Let leave event fire before enter event\n          affectedLayers.unshift(lastPickedLayer);\n        }\n      }\n\n      // Update layer manager context\n      lastPickedInfo.layerId = pickedLayerId;\n      lastPickedInfo.index = pickedObjectIndex;\n      lastPickedInfo.info = null;\n    }\n  }\n\n  const viewport = getViewportFromCoordinates({viewports}); // TODO - add coords\n  const coordinate = viewport && viewport.unproject([x, y]);\n\n  const baseInfo = {\n    color: null,\n    layer: null,\n    index: -1,\n    picked: false,\n    x,\n    y,\n    pixel: [x, y],\n    coordinate,\n    // TODO remove the lngLat prop after compatibility check\n    lngLat: coordinate,\n    devicePixel: [deviceX, deviceY],\n    pixelRatio\n  };\n\n  // Use a Map to store all picking infos.\n  // The following two forEach loops are the result of\n  // https://github.com/uber/deck.gl/issues/443\n  // Please be very careful when changing this pattern\n  const infos = new Map();\n\n  affectedLayers.forEach(layer => {\n    let info = Object.assign({}, baseInfo);\n\n    if (layer === pickedLayer) {\n      info.color = pickedColor;\n      info.index = pickedObjectIndex;\n      info.picked = true;\n    }\n\n    info = getLayerPickingInfo({layer, info, mode});\n\n    if (layer === pickedLayer && mode === 'hover') {\n      lastPickedInfo.info = info;\n    }\n\n    if (mode === 'hover') {\n      const pickingSelectedColor =\n        layer.props.autoHighlight && pickedLayer === layer ? pickedColor : null;\n\n      layer.setModuleParameters({\n        pickingSelectedColor\n      });\n      // TODO this needsRedraw logic should be fixed in layer\n      layer.setNeedsRedraw();\n    }\n\n    // This guarantees that there will be only one copy of info for\n    // one composite layer\n    if (info) {\n      infos.set(info.layer.id, info);\n    }\n  });\n\n  const unhandledPickInfos = callLayerPickingCallbacks(infos, mode);\n\n  return unhandledPickInfos;\n}\n\n// Per-layer event handlers (e.g. onClick, onHover) are provided by the\n// user and out of deck.gl's control. It's very much possible that\n// the user calls React lifecycle methods in these function, such as\n// ReactComponent.setState(). React lifecycle methods sometimes induce\n// a re-render and re-generation of props of deck.gl and its layers,\n// which invalidates all layers currently passed to this very function.\n\n// Therefore, per-layer event handlers must be invoked at the end\n// of the picking operation. NO operation that relies on the states of current\n// layers should be called after this code.\nfunction callLayerPickingCallbacks(infos, mode) {\n  const unhandledPickInfos = [];\n\n  infos.forEach(info => {\n    let handled = false;\n    switch (mode) {\n      case 'click':\n        handled = info.layer.onClick(info);\n        break;\n      case 'hover':\n        handled = info.layer.onHover(info);\n        break;\n      case 'query':\n        break;\n      default:\n        throw new Error('unknown pick type');\n    }\n\n    if (!handled) {\n      unhandledPickInfos.push(info);\n    }\n  });\n\n  return unhandledPickInfos;\n}\n\n/**\n * Pick at a specified pixel with a tolerance radius\n * Returns the closest object to the pixel in shape `{pickedColor, pickedLayer, pickedObjectIndex}`\n */\nexport function getClosestFromPickingBuffer(\n  gl,\n  {pickedColors, layers, deviceX, deviceY, deviceRadius, deviceRect}\n) {\n  assert(pickedColors);\n\n  // Traverse all pixels in picking results and find the one closest to the supplied\n  // [deviceX, deviceY]\n  const {x, y, width, height} = deviceRect;\n  let minSquareDistanceToCenter = deviceRadius * deviceRadius;\n  let closestPixelIndex = -1;\n  let i = 0;\n\n  for (let row = 0; row < height; row++) {\n    const dy = row + y - deviceY;\n    const dy2 = dy * dy;\n\n    if (dy2 > minSquareDistanceToCenter) {\n      // skip this row\n      i += 4 * width;\n    } else {\n      for (let col = 0; col < width; col++) {\n        // Decode picked layer from color\n        const pickedLayerIndex = pickedColors[i + 3] - 1;\n\n        if (pickedLayerIndex >= 0) {\n          const dx = col + x - deviceX;\n          const d2 = dx * dx + dy2;\n\n          if (d2 <= minSquareDistanceToCenter) {\n            minSquareDistanceToCenter = d2;\n            closestPixelIndex = i;\n          }\n        }\n        i += 4;\n      }\n    }\n  }\n\n  if (closestPixelIndex >= 0) {\n    // Decode picked object index from color\n    const pickedLayerIndex = pickedColors[closestPixelIndex + 3] - 1;\n    const pickedColor = pickedColors.slice(closestPixelIndex, closestPixelIndex + 4);\n    const pickedLayer = layers[pickedLayerIndex];\n    if (pickedLayer) {\n      const pickedObjectIndex = pickedLayer.decodePickingColor(pickedColor);\n      return {pickedColor, pickedLayer, pickedObjectIndex};\n    }\n    log.error('Picked non-existent layer. Is picking buffer corrupt?')();\n  }\n\n  return NO_PICKED_OBJECT;\n}\n/* eslint-enable max-depth, max-statements */\n\n/**\n * Examines a picking buffer for unique colors\n * Returns array of unique objects in shape `{x, y, pickedColor, pickedLayer, pickedObjectIndex}`\n */\nfunction getUniquesFromPickingBuffer(gl, {pickedColors, layers}) {\n  const uniqueColors = new Map();\n\n  // Traverse all pixels in picking results and get unique colors\n  if (pickedColors) {\n    for (let i = 0; i < pickedColors.length; i += 4) {\n      // Decode picked layer from color\n      const pickedLayerIndex = pickedColors[i + 3] - 1;\n\n      if (pickedLayerIndex >= 0) {\n        const pickedColor = pickedColors.slice(i, i + 4);\n        const colorKey = pickedColor.join(',');\n        // eslint-disable-next-line\n        if (!uniqueColors.has(colorKey)) {\n          const pickedLayer = layers[pickedLayerIndex];\n          // eslint-disable-next-line\n          if (pickedLayer) {\n            uniqueColors.set(colorKey, {\n              pickedColor,\n              pickedLayer,\n              pickedObjectIndex: pickedLayer.decodePickingColor(pickedColor)\n            });\n          } else {\n            log.error('Picked non-existent layer. Is picking buffer corrupt?')();\n          }\n        }\n      }\n    }\n  }\n\n  return Array.from(uniqueColors.values());\n}\n\n// Walk up the layer composite chain to populate the info object\nfunction getLayerPickingInfo({layer, info, mode}) {\n  while (layer && info) {\n    // For a composite layer, sourceLayer will point to the sublayer\n    // where the event originates from.\n    // It provides additional context for the composite layer's\n    // getPickingInfo() method to populate the info object\n    const sourceLayer = info.layer || layer;\n    info.layer = layer;\n    // layer.pickLayer() function requires a non-null ```layer.state```\n    // object to funtion properly. So the layer refereced here\n    // must be the \"current\" layer, not an \"out-dated\" / \"invalidated\" layer\n    info = layer.pickLayer({info, mode, sourceLayer});\n    layer = layer.parent;\n  }\n  return info;\n}\n"],"file":"pick-layers.js"}