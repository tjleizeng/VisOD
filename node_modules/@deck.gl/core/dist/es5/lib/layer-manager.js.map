{"version":3,"sources":["../../../src/lib/layer-manager.js"],"names":["LOG_PRIORITY_LIFECYCLE","LOG_PRIORITY_LIFECYCLE_MINOR","INITIAL_CONTEXT","Object","seal","layerManager","gl","useDevicePixels","stats","shaderCache","pickingFBO","pickingEvent","lastPickedInfo","animationProps","userData","layerName","layer","Layer","LayerManager","viewport","lastRenderedLayers","layers","context","assign","ShaderCache","_cachePrograms","Stats","id","index","layerId","info","Viewport","layerFilter","drawPickingColors","_needsRedraw","_needsUpdate","_debug","_activateViewport","bind","_initSeer","_editSeer","seer","removeListener","clearRedrawFlags","_checkIfNeedsRedraw","reason","layerIds","filter","find","indexOf","props","debug","setLayers","setNeedsRedraw","newLayers","log","Boolean","_updateLayers","oldLayers","error","generatedLayers","needsUpdate","pass","viewports","views","redrawReason","customRender","onViewportActive","x","y","lastPickedLayerId","l","coordinate","unproject","lngLat","color","object","mode","radius","depth","event","getLayers","result","_getPickingBuffer","width","height","redraw","layerNeedsRedraw","getNeedsRedraw","oldViewport","viewportChanged","equals","setChangeFlags","_updateLayer","Framebuffer","resize","canvas","oldLayerMap","oldLayer","warn","_updateSublayersRecursively","error2","_finalizeOldLayers","firstError","newLayer","sublayers","validateProps","_initializeLayer","_transferLayerState","push","isComposite","getSubLayers","err","_finalizeLayer","_initialize","lifecycle","LIFECYCLE","INITIALIZED","internalState","getModels","model","_transferState","MATCHED","AWAITING_GC","printChangeFlags","_update","AWAITING_FINALIZATION","_finalize","FINALIZED","forEach","payload","type","valuePath","itemKey","slice","value","map","constructor","updateLayers"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport assert from '../utils/assert';\nimport {Framebuffer, _ShaderCache as ShaderCache} from 'luma.gl';\nimport seer from 'seer';\nimport Layer from './layer';\nimport {drawLayers} from './draw-layers';\nimport {pickObject, pickVisibleObjects} from './pick-layers';\nimport {LIFECYCLE} from '../lifecycle/constants';\nimport log from '../utils/log';\nimport {flatten} from '../utils/flatten';\nimport {Stats} from 'probe.gl';\n\nimport Viewport from '../viewports/viewport';\n\nimport {\n  setPropOverrides,\n  layerEditListener,\n  seerInitListener,\n  initLayerInSeer,\n  updateLayerInSeer\n} from './seer-integration';\n\nconst LOG_PRIORITY_LIFECYCLE = 2;\nconst LOG_PRIORITY_LIFECYCLE_MINOR = 4;\n\n// CONTEXT IS EXPOSED TO LAYERS\nconst INITIAL_CONTEXT = Object.seal({\n  layerManager: null,\n  gl: null,\n\n  // Settings\n  useDevicePixels: true, // Exposed in case custom layers need to adjust sizes\n\n  // General resources\n  stats: null, // for tracking lifecycle performance\n\n  // GL Resources\n  shaderCache: null,\n  pickingFBO: null, // Screen-size framebuffer that layers can reuse\n\n  // State\n  pickingEvent: null,\n  lastPickedInfo: null,\n\n  animationProps: null,\n\n  userData: {} // Place for any custom app `context`\n});\n\nconst layerName = layer => (layer instanceof Layer ? `${layer}` : !layer ? 'null' : 'invalid');\n\nexport default class LayerManager {\n  // eslint-disable-next-line\n  constructor(gl, {stats, viewport = null} = {}) {\n    // Currently deck.gl expects the DeckGL.layers array to be different\n    // whenever React rerenders. If the same layers array is used, the\n    // LayerManager's diffing algorithm will generate a fatal error and\n    // break the rendering.\n\n    // `this.lastRenderedLayers` stores the UNFILTERED layers sent\n    // down to LayerManager, so that `layers` reference can be compared.\n    // If it's the same across two React render calls, the diffing logic\n    // will be skipped.\n    this.lastRenderedLayers = [];\n    this.layers = [];\n\n    this.context = Object.assign({}, INITIAL_CONTEXT, {\n      layerManager: this,\n\n      gl,\n      // Enabling luma.gl Program caching using private API (_cachePrograms)\n      shaderCache: gl && new ShaderCache({gl, _cachePrograms: true}),\n      stats: stats || new Stats({id: 'deck.gl'}),\n      lastPickedInfo: {\n        // For callback tracking and autohighlight\n        index: -1,\n        layerId: null,\n        info: null\n      },\n      // Make sure context.viewport is not empty on the first layer initialization\n      viewport: viewport || new Viewport({id: 'DEFAULT-INITIAL-VIEWPORT'}) // Current viewport, exposed to layers for project* function\n    });\n\n    this.layerFilter = null;\n    this.drawPickingColors = false;\n\n    this._needsRedraw = 'Initial render';\n    this._needsUpdate = false;\n    this._debug = false;\n\n    this._activateViewport = this._activateViewport.bind(this);\n\n    // Seer integration\n    this._initSeer = this._initSeer.bind(this);\n    this._editSeer = this._editSeer.bind(this);\n\n    Object.seal(this);\n\n    seerInitListener(this._initSeer);\n    layerEditListener(this._editSeer);\n  }\n\n  // Method to call when the layer manager is not needed anymore.\n  // Currently used in the <DeckGL> componentWillUnmount lifecycle to unbind Seer listeners.\n  finalize() {\n    seer.removeListener(this._initSeer);\n    seer.removeListener(this._editSeer);\n  }\n\n  // Check if a redraw is needed\n  needsRedraw({clearRedrawFlags = true} = {}) {\n    return this._checkIfNeedsRedraw(clearRedrawFlags);\n  }\n\n  // Check if a deep update of all layers is needed\n  needsUpdate() {\n    return this._needsUpdate;\n  }\n\n  // Layers will be redrawn (in next animation frame)\n  setNeedsRedraw(reason) {\n    this._needsRedraw = this._needsRedraw || reason;\n  }\n\n  // Layers will be updated deeply (in next animation frame)\n  // Potentially regenerating attributes and sub layers\n  setNeedsUpdate(reason) {\n    this._needsUpdate = this._needsUpdate || reason;\n  }\n\n  // Gets an (optionally) filtered list of layers\n  getLayers({layerIds = null} = {}) {\n    // Filtering by layerId compares beginning of strings, so that sublayers will be included\n    // Dependes on the convention of adding suffixes to the parent's layer name\n    return layerIds\n      ? this.layers.filter(layer => layerIds.find(layerId => layer.id.indexOf(layerId) === 0))\n      : this.layers;\n  }\n\n  /**\n   * Set props needed for layer rendering and picking.\n   * Parameters are to be passed as a single object, with the following values:\n   * @param {Boolean} useDevicePixels\n   */\n  /* eslint-disable complexity, max-statements */\n  setProps(props) {\n    if ('debug' in props) {\n      this._debug = props.debug;\n    }\n\n    // A way for apps to add data to context that can be accessed in layers\n    if ('userData' in props) {\n      this.context.userData = props.userData;\n    }\n\n    if ('useDevicePixels' in props) {\n      this.context.useDevicePixels = props.useDevicePixels;\n    }\n\n    // TODO - For now we set layers before viewports to preserve changeFlags\n    if ('layers' in props) {\n      this.setLayers(props.layers);\n    }\n\n    if ('layerFilter' in props) {\n      if (this.layerFilter !== props.layerFilter) {\n        this.layerFilter = props.layerFilter;\n        this.setNeedsRedraw('layerFilter changed');\n      }\n    }\n\n    if ('drawPickingColors' in props) {\n      if (props.drawPickingColors !== this.drawPickingColors) {\n        this.drawPickingColors = props.drawPickingColors;\n        this.setNeedsRedraw('drawPickingColors changed');\n      }\n    }\n  }\n  /* eslint-enable complexity, max-statements */\n\n  // Supply a new layer list, initiating sublayer generation and layer matching\n  setLayers(newLayers) {\n    // TODO - something is generating state updates that cause rerender of the same\n    if (newLayers === this.lastRenderedLayers) {\n      log.log(3, 'Ignoring layer update due to layer array not changed')();\n      return this;\n    }\n    this.lastRenderedLayers = newLayers;\n\n    newLayers = flatten(newLayers, {filter: Boolean});\n\n    for (const layer of newLayers) {\n      layer.context = this.context;\n    }\n\n    const {error, generatedLayers} = this._updateLayers({\n      oldLayers: this.layers,\n      newLayers\n    });\n\n    this.layers = generatedLayers;\n\n    // Throw first error found, if any\n    if (error) {\n      throw error;\n    }\n    return this;\n  }\n\n  // Update layers from last cycle if `setNeedsUpdate()` has been called\n  updateLayers() {\n    // NOTE: For now, even if only some layer has changed, we update all layers\n    // to ensure that layer id maps etc remain consistent even if different\n    // sublayers are rendered\n    const reason = this.needsUpdate();\n    if (reason) {\n      this.setNeedsRedraw(`updating layers: ${reason}`);\n      // HACK - Call with a copy of lastRenderedLayers to trigger a full update\n      this.setLayers([...this.lastRenderedLayers]);\n    }\n  }\n\n  //\n  // METHODS FOR LAYERS\n  //\n\n  // Draw all layers in all views\n  drawLayers({\n    pass = 'render to screen',\n    viewports,\n    views,\n    redrawReason = 'unknown reason',\n    customRender = false\n  }) {\n    const {drawPickingColors} = this;\n    const {gl, useDevicePixels} = this.context;\n\n    // render this viewport\n    drawLayers(gl, {\n      layers: this.layers,\n      viewports,\n      views,\n      onViewportActive: this._activateViewport,\n      useDevicePixels,\n      drawPickingColors,\n      pass,\n      layerFilter: this.layerFilter,\n      redrawReason,\n      customRender\n    });\n  }\n\n  // Returns a new picking info object by assuming the last picked object is still picked\n  getLastPickedObject({x, y, viewports}) {\n    const lastPickedInfo = this.context.lastPickedInfo.info;\n    const lastPickedLayerId = lastPickedInfo && lastPickedInfo.layer && lastPickedInfo.layer.id;\n    const layer = lastPickedLayerId ? this.layers.find(l => l.id === lastPickedLayerId) : null;\n    const coordinate = viewports[0] && viewports[0].unproject([x, y]);\n\n    const info = {\n      x,\n      y,\n      coordinate,\n      // TODO remove the lngLat prop after compatibility check\n      lngLat: coordinate,\n      layer\n    };\n\n    if (layer) {\n      return Object.assign({}, lastPickedInfo, info);\n    }\n    return Object.assign(info, {color: null, object: null, index: -1});\n  }\n\n  // Pick the closest info at given coordinate\n  pickObject({x, y, mode, radius = 0, layerIds, viewports, depth = 1, event = null}) {\n    const {gl, useDevicePixels} = this.context;\n    // Allow layers to access the event\n    this.context.pickingEvent = event;\n\n    const layers = this.getLayers({layerIds});\n\n    const result = pickObject(gl, {\n      // User params\n      x,\n      y,\n      radius,\n      layers,\n      mode,\n      layerFilter: this.layerFilter,\n      depth,\n      // Injected params\n      viewports,\n      onViewportActive: this._activateViewport,\n      pickingFBO: this._getPickingBuffer(),\n      lastPickedInfo: this.context.lastPickedInfo,\n      useDevicePixels\n    });\n\n    // Clear the current event\n    this.context.pickingEvent = null;\n    return result;\n  }\n\n  // Get all unique infos within a bounding box\n  pickObjects({x, y, width, height, layerIds, viewports}) {\n    const {gl, useDevicePixels} = this.context;\n\n    const layers = this.getLayers({layerIds});\n\n    return pickVisibleObjects(gl, {\n      x,\n      y,\n      width,\n      height,\n      layers,\n      layerFilter: this.layerFilter,\n      mode: 'pickObjects',\n      viewports,\n      onViewportActive: this._activateViewport,\n      pickingFBO: this._getPickingBuffer(),\n      useDevicePixels\n    });\n  }\n\n  //\n  // PRIVATE METHODS\n  //\n\n  _checkIfNeedsRedraw(clearRedrawFlags) {\n    let redraw = this._needsRedraw;\n    if (clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n\n    // This layers list doesn't include sublayers, relying on composite layers\n    for (const layer of this.layers) {\n      // Call every layer to clear their flags\n      const layerNeedsRedraw = layer.getNeedsRedraw({clearRedrawFlags});\n      redraw = redraw || layerNeedsRedraw;\n    }\n\n    return redraw;\n  }\n\n  // Make a viewport \"current\" in layer context, updating viewportChanged flags\n  _activateViewport(viewport) {\n    const oldViewport = this.context.viewport;\n    const viewportChanged = !oldViewport || !viewport.equals(oldViewport);\n\n    if (viewportChanged) {\n      log.log(4, 'Viewport changed', viewport)();\n\n      this.context.viewport = viewport;\n\n      // Update layers states\n      // Let screen space layers update their state based on viewport\n      for (const layer of this.layers) {\n        layer.setChangeFlags({viewportChanged: 'Viewport changed'});\n        this._updateLayer(layer);\n      }\n    }\n\n    assert(this.context.viewport, 'LayerManager: viewport not set');\n\n    return this;\n  }\n\n  _getPickingBuffer() {\n    const {gl} = this.context;\n    // Create a frame buffer if not already available\n    this.context.pickingFBO = this.context.pickingFBO || new Framebuffer(gl);\n    // Resize it to current canvas size (this is a noop if size hasn't changed)\n    this.context.pickingFBO.resize({width: gl.canvas.width, height: gl.canvas.height});\n    return this.context.pickingFBO;\n  }\n\n  // Match all layers, checking for caught errors\n  // To avoid having an exception in one layer disrupt other layers\n  // TODO - mark layers with exceptions as bad and remove from rendering cycle?\n  _updateLayers({oldLayers, newLayers}) {\n    // Create old layer map\n    const oldLayerMap = {};\n    for (const oldLayer of oldLayers) {\n      if (oldLayerMap[oldLayer.id]) {\n        log.warn(`Multiple old layers with same id ${layerName(oldLayer)}`)();\n      } else {\n        oldLayerMap[oldLayer.id] = oldLayer;\n      }\n    }\n\n    // Allocate array for generated layers\n    const generatedLayers = [];\n\n    // Match sublayers\n    const error = this._updateSublayersRecursively({\n      newLayers,\n      oldLayerMap,\n      generatedLayers\n    });\n\n    // Finalize unmatched layers\n    const error2 = this._finalizeOldLayers(oldLayerMap);\n\n    this._needsUpdate = false;\n\n    const firstError = error || error2;\n    return {error: firstError, generatedLayers};\n  }\n\n  // Note: adds generated layers to `generatedLayers` array parameter\n  _updateSublayersRecursively({newLayers, oldLayerMap, generatedLayers}) {\n    let error = null;\n\n    for (const newLayer of newLayers) {\n      newLayer.context = this.context;\n\n      // Given a new coming layer, find its matching old layer (if any)\n      const oldLayer = oldLayerMap[newLayer.id];\n      if (oldLayer === null) {\n        // null, rather than undefined, means this id was originally there\n        log.warn(`Multiple new layers with same id ${layerName(newLayer)}`)();\n      }\n      // Remove the old layer from candidates, as it has been matched with this layer\n      oldLayerMap[newLayer.id] = null;\n\n      let sublayers = null;\n\n      // We must not generate exceptions until after layer matching is complete\n      try {\n        if (this._debug && oldLayer !== newLayer) {\n          newLayer.validateProps();\n        }\n\n        if (!oldLayer) {\n          this._initializeLayer(newLayer);\n          initLayerInSeer(newLayer); // Initializes layer in seer chrome extension (if connected)\n        } else {\n          this._transferLayerState(oldLayer, newLayer);\n          this._updateLayer(newLayer);\n          updateLayerInSeer(newLayer); // Updates layer in seer chrome extension (if connected)\n        }\n        generatedLayers.push(newLayer);\n\n        // Call layer lifecycle method: render sublayers\n        sublayers = newLayer.isComposite && newLayer.getSubLayers();\n        // End layer lifecycle method: render sublayers\n      } catch (err) {\n        log.warn(`error during matching of ${layerName(newLayer)}`, err)();\n        error = error || err; // Record first exception\n      }\n\n      if (sublayers) {\n        this._updateSublayersRecursively({\n          newLayers: sublayers,\n          oldLayerMap,\n          generatedLayers\n        });\n      }\n    }\n\n    return error;\n  }\n\n  // Finalize any old layers that were not matched\n  _finalizeOldLayers(oldLayerMap) {\n    let error = null;\n    for (const layerId in oldLayerMap) {\n      const layer = oldLayerMap[layerId];\n      if (layer) {\n        error = error || this._finalizeLayer(layer);\n      }\n    }\n    return error;\n  }\n\n  // EXCEPTION SAFE LAYER ACCESS\n\n  // Initializes a single layer, calling layer methods\n  _initializeLayer(layer) {\n    log.log(LOG_PRIORITY_LIFECYCLE, `initializing ${layerName(layer)}`)();\n\n    let error = null;\n    try {\n      layer._initialize();\n      layer.lifecycle = LIFECYCLE.INITIALIZED;\n    } catch (err) {\n      log.warn(`error while initializing ${layerName(layer)}\\n`, err)();\n      error = error || err;\n      // TODO - what should the lifecycle state be here? LIFECYCLE.INITIALIZATION_FAILED?\n    }\n\n    // Set back pointer (used in picking)\n    layer.internalState.layer = layer;\n\n    // Save layer on model for picking purposes\n    // store on model.userData rather than directly on model\n    for (const model of layer.getModels()) {\n      model.userData.layer = layer;\n    }\n\n    return error;\n  }\n\n  _transferLayerState(oldLayer, newLayer) {\n    newLayer._transferState(oldLayer);\n    newLayer.lifecycle = LIFECYCLE.MATCHED;\n\n    if (newLayer !== oldLayer) {\n      log.log(\n        LOG_PRIORITY_LIFECYCLE_MINOR,\n        `matched ${layerName(newLayer)}`,\n        oldLayer,\n        '->',\n        newLayer\n      )();\n      oldLayer.lifecycle = LIFECYCLE.AWAITING_GC;\n    } else {\n      log.log(LOG_PRIORITY_LIFECYCLE_MINOR, `Matching layer is unchanged ${newLayer.id}`)();\n    }\n  }\n\n  // Updates a single layer, cleaning all flags\n  _updateLayer(layer) {\n    log.log(\n      LOG_PRIORITY_LIFECYCLE_MINOR,\n      `updating ${layer} because: ${layer.printChangeFlags()}`\n    )();\n    let error = null;\n    try {\n      layer._update();\n    } catch (err) {\n      log.warn(`error during update of ${layerName(layer)}`, err)();\n      // Save first error\n      error = err;\n    }\n    return error;\n  }\n\n  // Finalizes a single layer\n  _finalizeLayer(layer) {\n    assert(layer.lifecycle !== LIFECYCLE.AWAITING_FINALIZATION);\n    layer.lifecycle = LIFECYCLE.AWAITING_FINALIZATION;\n    let error = null;\n    this.setNeedsRedraw(`finalized ${layerName(layer)}`);\n    try {\n      layer._finalize();\n    } catch (err) {\n      log.warn(`error during finalization of ${layerName(layer)}`, err)();\n      error = err;\n    }\n    layer.lifecycle = LIFECYCLE.FINALIZED;\n    log.log(LOG_PRIORITY_LIFECYCLE, `finalizing ${layerName(layer)}`)();\n    return error;\n  }\n\n  // SEER INTEGRATION\n\n  /**\n   * Called upon Seer initialization, manually sends layers data.\n   */\n  _initSeer() {\n    this.layers.forEach(layer => {\n      initLayerInSeer(layer);\n      updateLayerInSeer(layer);\n    });\n  }\n\n  /**\n   * On Seer property edition, set override and update layers.\n   */\n  _editSeer(payload) {\n    if (payload.type !== 'edit' || payload.valuePath[0] !== 'props') {\n      return;\n    }\n\n    setPropOverrides(payload.itemKey, payload.valuePath.slice(1), payload.value);\n    const newLayers = this.layers.map(layer => new layer.constructor(layer.props));\n    this.updateLayers({newLayers});\n  }\n}\n"],"file":"layer-manager.js"}