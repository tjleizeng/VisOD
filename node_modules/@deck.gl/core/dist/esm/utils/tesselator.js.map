{"version":3,"sources":["../../../src/utils/tesselator.js"],"names":["fillArray","TypedArrayManager","overAlloc","typedArray","count","size","type","copy","newSize","length","allocSize","Math","max","ceil","newArray","_allocate","set","_release","Type","Float32Array","Uint16Array","Error","Tesselator","opts","attributes","typedArrayManager","indexLayout","bufferLayout","vertexCount","instanceCount","_attributeDefs","updateGeometry","Object","seal","data","getGeometry","positionFormat","fp64","positionSize","_rebuildGeometry","start","objects","geometry","startIndex","visitor","dataIndex","object","target","getValue","i","value","numVertices","source","_forEachGeometry","getGeometrySize","name","def","fp64Only","allocate","context","vertexStart","indexStart","geometrySize","geometryIndex","updateGeometryAttributes"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {fillArray} from './flatten';\n\nclass TypedArrayManager {\n  constructor({overAlloc = 1} = {}) {\n    this.overAlloc = overAlloc;\n  }\n\n  allocate(typedArray, count, {size, type, copy = false}) {\n    const newSize = count * size;\n    if (typedArray && newSize <= typedArray.length) {\n      return typedArray;\n    }\n\n    // Allocate at least one element to ensure a valid buffer\n    const allocSize = Math.max(Math.ceil(newSize * this.overAlloc), 1);\n    const newArray = this._allocate(type, allocSize);\n\n    if (typedArray && copy) {\n      newArray.set(typedArray);\n    }\n\n    this._release(typedArray);\n    return newArray;\n  }\n\n  _allocate(Type = Float32Array, size) {\n    if (Type === Uint16Array && size > 65535) {\n      throw new Error('Vertex count exceeds browser index limit');\n    }\n    // TODO - check if available in pool\n    return new Type(size);\n  }\n\n  _release(typedArray) {\n    // TODO - add to pool\n    // logFunctions.onUpdate({\n    //   level: LOG_DETAIL_PRIORITY,\n    //   message: `${attributeName} allocated ${allocCount}`,\n    //   id: this.id\n    // });\n  }\n}\n\nexport default class Tesselator {\n  constructor(opts = {}) {\n    const {attributes = {}} = opts;\n\n    this.typedArrayManager = new TypedArrayManager();\n    this.indexLayout = null;\n    this.bufferLayout = null;\n    this.vertexCount = 0;\n    this.instanceCount = 0;\n    this.attributes = {};\n    this._attributeDefs = attributes;\n\n    this.updateGeometry(opts);\n\n    Object.seal(this);\n  }\n\n  /* Public methods */\n  updateGeometry({data, getGeometry, positionFormat, fp64}) {\n    this.data = data;\n    this.getGeometry = getGeometry;\n    this.fp64 = fp64;\n    this.positionSize = positionFormat === 'XY' ? 2 : 3;\n    this._rebuildGeometry();\n  }\n\n  updatePartialGeometry({start, count, objects}) {\n    // TODO\n  }\n\n  /* Subclass interface */\n\n  // Update the positions of a single geometry\n  updateGeometryAttributes(geometry, startIndex, size) {\n    throw new Error('Not implemented');\n  }\n\n  // Returns the number of vertices in a geometry\n  getGeometrySize(geometry) {\n    throw new Error('Not implemented');\n  }\n\n  /* Private utility methods */\n\n  /**\n   * Visit all objects\n   * `data` is expected to be an iterable consistent with the base Layer expectation\n   */\n  _forEachGeometry(visitor) {\n    const {data, getGeometry} = this;\n    let dataIndex = 0;\n    for (const object of data) {\n      const geometry = getGeometry(object);\n      visitor(geometry, dataIndex++);\n    }\n  }\n\n  _updateAttribute({target, size, getValue}) {\n    const {data, bufferLayout} = this;\n\n    let i = 0;\n    let dataIndex = 0;\n    for (const object of data) {\n      const value = getValue(object, dataIndex);\n      const numVertices = bufferLayout[dataIndex++];\n\n      fillArray({target, source: value, start: i, count: numVertices});\n      i += numVertices * size;\n    }\n    return target;\n  }\n\n  _rebuildGeometry() {\n    if (!this.data || !this.getGeometry) {\n      return;\n    }\n\n    // count instances\n    const indexLayout = [];\n    const bufferLayout = [];\n    let instanceCount = 0;\n    this._forEachGeometry((geometry, dataIndex) => {\n      const count = this.getGeometrySize(geometry);\n      instanceCount += count;\n      bufferLayout[dataIndex] = count;\n    });\n\n    // allocate attributes\n    const {attributes, _attributeDefs, typedArrayManager, fp64} = this;\n    for (const name in _attributeDefs) {\n      const def = _attributeDefs[name];\n\n      // do not create fp64-only attributes unless in fp64 mode\n      if (!def.fp64Only || fp64) {\n        attributes[name] = typedArrayManager.allocate(attributes[name], instanceCount, def);\n      }\n    }\n\n    this.indexLayout = indexLayout;\n    this.bufferLayout = bufferLayout;\n    this.instanceCount = instanceCount;\n\n    const context = {\n      vertexStart: 0,\n      indexStart: 0\n    };\n    this._forEachGeometry((geometry, dataIndex) => {\n      const geometrySize = bufferLayout[dataIndex];\n      context.geometryIndex = dataIndex;\n      context.geometrySize = geometrySize;\n      this.updateGeometryAttributes(geometry, context);\n      context.vertexStart += geometrySize;\n      context.indexStart += indexLayout[dataIndex] || 0;\n    });\n\n    this.vertexCount = context.indexStart;\n  }\n}\n"],"file":"tesselator.js"}