{"version":3,"sources":["../../../src/views/orbit-view.js"],"names":["View","Viewport","createMat4","transformVector","mat4","OrbitController","DEGREES_TO_RADIANS","Math","PI","OrbitViewport","xyz","topLeft","v","pixelProjectionMatrix","x","y","z","y2","height","pixelUnprojectionMatrix","OrbitView","props","viewState","width","fovy","fov","near","far","aspect","Number","isFinite","fovyRadians","id","viewMatrix","_getViewMatrix","projectionMatrix","perspective","distance","rotationX","rotationOrbit","orbitAxis","lookAt","up","zoom","rotationMatrix","rotateX","rotateZ","rotateY","translateMatrix","scale","translate","multiply","boundingBox","_getViewport","_getControllerProps","type","halfMaxSide","max","tan","displayName"],"mappings":"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","sourcesContent":["import View from './view';\nimport Viewport from '../viewports/viewport';\n\n// TODO - use math.gl\nimport {createMat4, transformVector} from '../utils/math-utils';\nimport * as mat4 from 'gl-matrix/mat4';\nimport OrbitController from '../controllers/orbit-controller';\n\nconst DEGREES_TO_RADIANS = Math.PI / 180;\n\n// TODO - remove need for custom project overrides\nclass OrbitViewport extends Viewport {\n  project(xyz, {topLeft = false} = {}) {\n    const v = transformVector(this.pixelProjectionMatrix, [...xyz, 1]);\n    const [x, y, z] = v;\n    const y2 = topLeft ? this.height - y : y;\n    return [x, y2, z];\n  }\n\n  unproject(xyz, {topLeft = false} = {}) {\n    const [x, y, z] = xyz;\n    const y2 = topLeft ? this.height - y : y;\n    return transformVector(this.pixelUnprojectionMatrix, [x, y2, z, 1]);\n  }\n}\n\nexport default class OrbitView extends View {\n  // Get camera `distance` to make view fit a box centered at lookat position in the viewport.\n  // @param {Array} boundingBox - [sizeX, sizeY, sizeZ]], defines the dimensions of bounding box\n  static getDistance({boundingBox, fov}) {\n    const halfMaxSide = Math.max(boundingBox[0], boundingBox[1], boundingBox[2]) / 2;\n    const distance = halfMaxSide / Math.tan(((fov / 180) * Math.PI) / 2);\n    return distance;\n  }\n\n  get controller() {\n    return this._getControllerProps({\n      type: OrbitController\n    });\n  }\n\n  /* eslint-disable complexity, max-statements */\n  _getViewport(props) {\n    const {viewState} = props;\n    const width = props.width || 1;\n    const height = props.height || 1;\n\n    // Get view matrix parameters from view state\n    // Projection matrix arguments\n    // TODO - Extracting from viewState is deprecated\n    const fovy = props.fov || props.fovy || viewState.fovy || 75; // Field of view covered by camera\n    const near = props.near || viewState.near || 1; // Distance of near clipping plane\n    const far = props.far || viewState.far || 100; // Distance of far clipping plane\n    const aspect = Number.isFinite(viewState.aspect) ? viewState.aspect : width / height;\n\n    const fovyRadians = fovy * DEGREES_TO_RADIANS;\n\n    return new OrbitViewport({\n      id: this.id,\n      viewMatrix: this._getViewMatrix(props.viewState),\n      projectionMatrix: mat4.perspective([], fovyRadians, aspect, near, far),\n      x: props.x,\n      y: props.y,\n      width,\n      height\n    });\n  }\n  /* eslint-enable complexity, max-statements */\n\n  _getViewMatrix(viewState) {\n    const {\n      distance, // From eye position to lookAt\n      rotationX = 0, // Rotating angle around X axis\n      rotationOrbit = 0, // Rotating angle around orbit axis\n      orbitAxis = 'Z', // Orbit axis with 360 degrees rotating freedom, can only be 'Y' or 'Z'\n\n      lookAt = [0, 0, 0], // Which point is camera looking at, default origin\n      up = [0, 1, 0], // Defines up direction, default positive y axis\n      zoom = 1\n    } = viewState;\n\n    const rotationMatrix = mat4.rotateX([], createMat4(), (-rotationX / 180) * Math.PI);\n    if (orbitAxis === 'Z') {\n      mat4.rotateZ(rotationMatrix, rotationMatrix, (-rotationOrbit / 180) * Math.PI);\n    } else {\n      mat4.rotateY(rotationMatrix, rotationMatrix, (-rotationOrbit / 180) * Math.PI);\n    }\n\n    const translateMatrix = createMat4();\n    mat4.scale(translateMatrix, translateMatrix, [zoom, zoom, zoom]);\n    mat4.translate(translateMatrix, translateMatrix, [-lookAt[0], -lookAt[1], -lookAt[2]]);\n\n    const viewMatrix = mat4.lookAt([], [0, 0, distance], [0, 0, 0], up);\n    mat4.multiply(\n      viewMatrix,\n      viewMatrix,\n      mat4.multiply(rotationMatrix, rotationMatrix, translateMatrix)\n    );\n\n    return viewMatrix;\n  }\n\n  /** Move camera to make a model bounding box centered at lookat position fit in the viewport.\n   * @param {Array} boundingBox - [sizeX, sizeY, sizeZ]], define the dimensions of bounding box\n   * @returns a new OrbitViewport object\n   */\n  fitBounds(boundingBox, viewState) {\n    const {width, height, fov, near, far} = this;\n\n    return this._getViewport({\n      width,\n      height,\n      fov,\n      near,\n      far\n    });\n  }\n}\n\nOrbitView.displayName = 'OrbitView';\n"],"file":"orbit-view.js"}