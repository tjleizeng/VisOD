{"version":3,"sources":["../../../src/path-layer/path-tesselator.js"],"names":["Tesselator","experimental","fp64LowPart","fp64Module","colorArray","PathTesselator","data","getGeometry","positionFormat","fp64","attributes","startPositions","size","endPositions","leftDeltas","rightDeltas","startEndPositions64XyLow","fp64Only","attributeName","target","accessor","_updateAttribute","getValue","object","color","length","index","path","Math","max","getPathLength","context","numPoints","geometrySize","isPathClosed","isClosed","startPoint","getPointOnPath","endPoint","prevPoint","nextPoint","i","vertexStart","ptIndex","Number","isFinite","positionSize","firstPoint","lastPoint"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {experimental} from '@deck.gl/core';\nconst {Tesselator} = experimental;\nimport {fp64 as fp64Module} from 'luma.gl';\nconst {fp64LowPart} = fp64Module;\n\n// colorArray is used to copy over color values if the passed color is an RGB\n// array instead of RGBA\nconst colorArray = [0, 0, 0, 255];\n\n// This class is set up to allow querying one attribute at a time\n// the way the AttributeManager expects it\nexport default class PathTesselator extends Tesselator {\n  constructor({data, getGeometry, positionFormat, fp64}) {\n    super({\n      data,\n      getGeometry,\n      fp64,\n      positionFormat,\n      attributes: {\n        startPositions: {size: 3},\n        endPositions: {size: 3},\n        leftDeltas: {size: 3},\n        rightDeltas: {size: 3},\n        startEndPositions64XyLow: {size: 4, fp64Only: true}\n      }\n    });\n  }\n\n  /* Getters */\n  get(attributeName, target, accessor) {\n    if (this.attributes[attributeName]) {\n      return this.attributes[attributeName];\n    }\n\n    switch (attributeName) {\n      case 'strokeWidths':\n        return this._updateAttribute({\n          target,\n          size: 1,\n          getValue: object => [accessor(object)]\n        });\n\n      case 'dashArrays':\n        return this._updateAttribute({target, size: 2, getValue: accessor});\n\n      case 'colors':\n        return this._updateAttribute({\n          target,\n          size: 4,\n          getValue: object => {\n            const color = accessor(object);\n            if (color.length === 4) {\n              return color;\n            }\n            colorArray[0] = color[0];\n            colorArray[1] = color[1];\n            colorArray[2] = color[2];\n            return colorArray;\n          }\n        });\n\n      case 'pickingColors':\n        return this._updateAttribute({\n          target,\n          size: 3,\n          getValue: (object, index) => accessor(index)\n        });\n\n      default:\n        return null;\n    }\n  }\n\n  /* Implement base Tesselator interface */\n  getGeometrySize(path) {\n    return Math.max(0, this.getPathLength(path) - 1);\n  }\n\n  /* eslint-disable max-statements, complexity */\n  updateGeometryAttributes(path, context) {\n    const {\n      attributes: {startPositions, endPositions, leftDeltas, rightDeltas, startEndPositions64XyLow},\n      fp64\n    } = this;\n\n    const numPoints = context.geometrySize + 1;\n    if (numPoints < 2) {\n      // ignore invalid path\n      return;\n    }\n    const isPathClosed = this.isClosed(path);\n\n    let startPoint = this.getPointOnPath(path, 0);\n    let endPoint = this.getPointOnPath(path, 1);\n    let prevPoint = isPathClosed ? this.getPointOnPath(path, numPoints - 2) : startPoint;\n    let nextPoint;\n\n    for (let i = context.vertexStart, ptIndex = 1; ptIndex < numPoints; i++, ptIndex++) {\n      if (ptIndex + 1 < numPoints) {\n        nextPoint = this.getPointOnPath(path, ptIndex + 1);\n      } else {\n        nextPoint = isPathClosed ? this.getPointOnPath(path, 1) : endPoint;\n      }\n\n      startPositions[i * 3] = startPoint[0];\n      startPositions[i * 3 + 1] = startPoint[1];\n      startPositions[i * 3 + 2] = startPoint[2] || 0;\n\n      endPositions[i * 3] = endPoint[0];\n      endPositions[i * 3 + 1] = endPoint[1];\n      endPositions[i * 3 + 2] = endPoint[2] || 0;\n\n      leftDeltas[i * 3] = startPoint[0] - prevPoint[0];\n      leftDeltas[i * 3 + 1] = startPoint[1] - prevPoint[1];\n      leftDeltas[i * 3 + 2] = startPoint[2] - prevPoint[2] || 0;\n\n      rightDeltas[i * 3] = nextPoint[0] - endPoint[0];\n      rightDeltas[i * 3 + 1] = nextPoint[1] - endPoint[1];\n      rightDeltas[i * 3 + 2] = nextPoint[2] - endPoint[2] || 0;\n\n      if (fp64) {\n        startEndPositions64XyLow[i * 4] = fp64LowPart(startPoint[0]);\n        startEndPositions64XyLow[i * 4 + 1] = fp64LowPart(startPoint[1]);\n        startEndPositions64XyLow[i * 4 + 2] = fp64LowPart(endPoint[0]);\n        startEndPositions64XyLow[i * 4 + 3] = fp64LowPart(endPoint[1]);\n      }\n\n      prevPoint = startPoint;\n      startPoint = endPoint;\n      endPoint = nextPoint;\n    }\n  }\n  /* eslint-enable max-statements, complexity */\n\n  /* Utilities */\n  getPathLength(path) {\n    if (Number.isFinite(path[0])) {\n      // flat format\n      return path.length / this.positionSize;\n    }\n    return path.length;\n  }\n\n  getPointOnPath(path, index) {\n    if (Number.isFinite(path[0])) {\n      // flat format\n      const {positionSize} = this;\n      // TODO - avoid creating new arrays when using binary\n      return [\n        path[index * positionSize],\n        path[index * positionSize + 1],\n        positionSize === 3 ? path[index * positionSize + 2] : 0\n      ];\n    }\n    return path[index];\n  }\n\n  isClosed(path) {\n    const numPoints = this.getPathLength(path);\n    const firstPoint = this.getPointOnPath(path, 0);\n    const lastPoint = this.getPointOnPath(path, numPoints - 1);\n    return (\n      firstPoint[0] === lastPoint[0] &&\n      firstPoint[1] === lastPoint[1] &&\n      firstPoint[2] === lastPoint[2]\n    );\n  }\n}\n"],"file":"path-tesselator.js"}